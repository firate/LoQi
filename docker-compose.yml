services:
  # Database Initialization
  db-init:
    image: alpine:latest
    volumes:
      - loqi_data:/data
      - ./scripts/schema-creation.sql:/scripts/schema-creation.sql
    command: |
      sh -c "
        echo ' Installing SQLite...'
        apk add --no-cache sqlite
      
        echo ' Checking database...'
        if [ ! -s /data/loqi.db ]; then
          echo ' Creating database with schema...'
          sqlite3 /data/loqi.db < /scripts/schema-creation.sql
          echo 'Database created successfully!'
      
          # Verify tables
          echo ' Verifying tables:'
          sqlite3 /data/loqi.db '.tables'
      
          # Check FTS5 table
          echo ' Checking FTS5 support:'
          sqlite3 /data/loqi.db 'SELECT name FROM sqlite_master WHERE type=\"table\" AND name LIKE \"%fts%\";'
      
        else
          echo 'Database already exists'
          sqlite3 /data/loqi.db '.tables'
        fi
      
        echo ' Database initialization completed!'
      "
    restart: "no"

  # Redis
  redis:
    image: redis:alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10 --save 60 10000
    environment:
      - REDIS_REPLICATION_MODE=master
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'
  
  # Main Application
  loqi:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    depends_on:
      db-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
    ports:
      - "${LOQI_HTTP_PORT:-5003}:8080"
      - "${LOQI_UDP_PORT:-10080}:10080/udp"
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Development}
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/loqi.db
      - ConnectionStrings__Redis=redis:6379
      - Logging__LogLevel__Default=Information
      - UdpListener__Port=10080
      - LoQi__Redis__Stream__MaxStreamLength=5000000
      - LoQi__Redis__Stream__ConsumerGroups__raw-logs__BatchSize=1000
      - LoQi__Redis__Stream__ConsumerGroups__raw-logs__BlockTimeMs=500
    volumes:
      - loqi_data:/app/data
      - loqi_logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  loqi_data:
    driver: local
  loqi_logs:
    driver: local